#!/bin/sh

# params: stringsFile
findUndefinedKeys() {
    echo "> Find undefined keys in: \"$1\""

    findOrDefineUndefinedEnumKeys "$1"
    findUndefinedStringsKeys "$1"
    findDuplicateStringsKeys "$1"
}

# params: stringsFile
sortStringsKeys() {
    sort -o "$1" "$1"
}

## HELPER

# params: index lineNumber message
warn() {
    echo "$1:$2:" | perl -p -e "s/$/ warning: Localization: $3/"
}

# params: -
enumFile() {
    if [ -z "$SCRIPT_INPUT_FILE_0" ]
    then
        enumFile=`find "$SRCROOT" -name "Strings.swift"`
    else
        enumFile="$SCRIPT_INPUT_FILE_0"
    fi
}

# params: -
enumKeys() {
    enumKeys=`cat "$enumFile" | egrep -o "case\s.*$" | sed "s/case //g"`
}

# params: -
stringsFiles() {
    IFS=$'\t\n'
    stringsFiles=("`find "$SRCROOT" -name "*.strings" -type f`")
    unset $IFS
}

# params: stringsFile
stringsKeys() {
    stringsKeys=`cat "$1" | egrep -o "^\"\w+\"" | sed "s/\"//g"`
}

# params: pattern file
lineNumber() {
    lineNumber=(`egrep --line-number -o "$1" "$2" | cut -f1 -d:`)
}

## UNDEFINED STRINGS KEYS

# params: stringsFile
findUndefinedStringsKeys() {
    enumFile
    stringsKeys "$1"

    for key in $stringsKeys
    do
        if ! egrep -q "case $key" "$enumFile"
        then
            lineNumber "^\"$key" "$1"
            warn $1 $lineNumber "Key doesn't exist: \"$key\""
        fi
    done
}

## DUPLICATE STRINGS KEYS

# params: stringsFile
findDuplicateStringsKeys() {
    stringsKeys "$1"

    duplicateKeys=`printf '%s\n' ${stringsKeys[@]} | awk '!($0 in seen){seen[$0];next} 1'`
    for key in $duplicateKeys
    do
        lineNumber "^\"$key" "$1"
        warn $1 $lineNumber "Key is duplicated: \"$key\""
    done
}

## UNDEFINED ENUM KEYS

# params: stringsFile
findUndefinedEnumKeys() {
    enumFile
    enumKeys

    for key in $enumKeys
    do
        if ! egrep -q "^\"$key" "$1"
        then
            warn "$1" 1 "Key is missing: \"$key\""
        fi
    done
}

# params: stringsFile
defineUndefinedEnumKeys() {
    enumFile
    enumKeys

    for key in $enumKeys
    do
        if ! egrep -q "^\"$key" "$1"
        then
            echo "\"$key\" = nil;" >> "$1"
        fi
    done
}

# params: stringsFile
findOrDefineUndefinedEnumKeys() {
    if echo "$1" | egrep -q ".*Default.strings$"
    then
        findUndefinedEnumKeys "$1"
    else
        defineUndefinedEnumKeys "$1"
    fi
}

## EXECUTE

stringsFiles
for stringsFile in $stringsFiles
do
    findUndefinedKeys "$stringsFile"
    sortStringsKeys "$stringsFile"
done

